{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h2 class="mb-4">Hospital Dashboard</h2>

<div class="dashboard-tip p-4 mb-4 d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3">
  <div class="fw-semibold">
    <strong>Tip:</strong> Click on any chart segment or bar to jump straight to the filtered patient list.
  </div>
</div>

<!-- Snapshot Overview -->
<div class="snapshot-wrapper mb-4">
  <div class="snapshot-grid">
    {% for card in snapshot_cards %}
    <div class="snapshot-card">
      <div class="d-flex align-items-center mb-3">
        <div class="snapshot-icon me-3">
          <i class="bi {{ card.icon }}"></i>
        </div>
        <div>
          <small class="text-uppercase text-muted">{{ card.title }}</small>
          <div class="snapshot-value">{{ card.value }}</div>
        </div>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">{{ card.subtext }}</small>
        {% if card.change %}
          {% if card.change.percent is not None %}
            <span class="badge {% if card.change.trend_positive %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %}">
              {% if card.change.trend_positive %}+{% endif %}{{ card.change.percent }}%
            </span>
          {% else %}
            <span class="badge bg-secondary-subtle text-secondary">{{ card.change.delta }}</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="snapshot-highlight mt-3">
    <div>
      <span class="text-uppercase text-muted small">{{ snapshot_highlight.label }}</span>
      <h5 class="mb-0">{{ snapshot_highlight.value }}</h5>
    </div>
    {% if snapshot_highlight.count %}
    <span class="badge bg-primary-subtle text-primary">{{ snapshot_highlight.count }} cases</span>
    {% endif %}
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-2 col-sm-6 mb-3">
    <div class="card stat-card text-white bg-primary">
      <div class="card-body">
        <h5 class="card-title">Total Patients</h5>
        <h2 class="mb-0">{{ total_patients }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-2 col-sm-6 mb-3">
    <div class="card stat-card text-white bg-success">
      <div class="card-body">
        <h5 class="card-title">Total Doctors</h5>
        <h2 class="mb-0">{{ total_doctors }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-2 col-sm-6 mb-3">
    <div class="card stat-card text-white bg-info">
      <div class="card-body">
        <h5 class="card-title">Departments</h5>
        <h2 class="mb-0">{{ total_departments }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-2 col-sm-6 mb-3">
    <div class="card stat-card text-white bg-secondary">
      <div class="card-body">
        <h5 class="card-title">Health Records</h5>
        <h2 class="mb-0">{{ total_health_records }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
  <div class="col-md-6 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Patient Gender Distribution</h5>
      </div>
      <div class="card-body">
        {% if has_gender_data %}
        <canvas id="genderChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Blood Type Distribution</h5>
      </div>
      <div class="card-body">
        {% if has_blood_type_data %}
        <canvas id="bloodTypeChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
  <div class="col-md-6 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Age Group Distribution</h5>
      </div>
      <div class="card-body">
        {% if has_age_group_data %}
        <canvas id="ageGroupChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">Patient Registrations Over Time (Last 12 Months)</h5>
      </div>
      <div class="card-body">
        {% if has_registration_data %}
        <canvas id="registrationChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Charts Row 3 -->
<div class="row mb-4">
  <div class="col-md-6 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-danger text-white">
        <h5 class="mb-0">Patients by Department</h5>
      </div>
      <div class="card-body">
        {% if has_department_data %}
        <canvas id="departmentChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">BMI Distribution</h5>
      </div>
      <div class="card-body">
        {% if has_bmi_data %}
        <canvas id="bmiChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Charts Row 4 -->
<div class="row mb-4">
  <div class="col-lg-6 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-dark text-white">
        <h5 class="mb-0">Visit Type Breakdown</h5>
      </div>
      <div class="card-body">
        {% if has_visit_type_data %}
        <canvas id="visitTypeChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">Patient Cities (Top 8)</h5>
      </div>
      <div class="card-body">
        {% if has_city_data %}
        <canvas id="cityChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Charts Row 5 -->
<div class="row mb-4">
  <div class="col-lg-5 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-dark text-white">
        <h5 class="mb-0">Top 10 Diagnoses</h5>
      </div>
      <div class="card-body">
        {% if has_diagnosis_data %}
        <canvas id="diagnosisChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-7 mb-3">
    <div class="card chart-card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Average Vitals by Department</h5>
      </div>
      <div class="card-body">
        {% if has_dept_vitals_data %}
        <canvas id="deptVitalsChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">Not enough data yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Helper function to navigate to filtered patient list
function navigateToFilteredPatients(filterType, filterValue) {
    const url = `{% url 'patient_list' %}?filter_type=${filterType}&filter_value=${encodeURIComponent(filterValue)}`;
    window.location.href = url;
}

// Gender Distribution (Pie Chart)
{% if has_gender_data %}
const genderCtx = document.getElementById('genderChart').getContext('2d');
new Chart(genderCtx, {
    type: 'pie',
    data: {
        labels: {{ gender_labels|safe }},
        datasets: [{
            data: {{ gender_counts|safe }},
            backgroundColor: [
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const label = {{ gender_labels|safe }}[index];
                navigateToFilteredPatients('gender', label);
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        return 'Click to view patients';
                    }
                }
            }
        }
    }
});
{% endif %}

// Blood Type Distribution (Doughnut Chart)
{% if has_blood_type_data %}
const bloodTypeCtx = document.getElementById('bloodTypeChart').getContext('2d');
new Chart(bloodTypeCtx, {
    type: 'doughnut',
    data: {
        labels: {{ blood_type_labels|safe }},
        datasets: [{
            data: {{ blood_type_counts|safe }},
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const label = {{ blood_type_labels|safe }}[index];
                navigateToFilteredPatients('blood_type', label);
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        return 'Click to view patients';
                    }
                }
            }
        }
    }
});
{% endif %}

// Age Group Distribution (Bar Chart)
{% if has_age_group_data %}
const ageGroupCtx = document.getElementById('ageGroupChart').getContext('2d');
new Chart(ageGroupCtx, {
    type: 'bar',
    data: {
        labels: {{ age_group_labels|safe }},
        datasets: [{
            label: 'Number of Patients',
            data: {{ age_group_counts|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const label = {{ age_group_labels|safe }}[index];
                navigateToFilteredPatients('age_group', label);
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        return 'Click to view patients';
                    }
                }
            }
        }
    }
});
{% endif %}

// Patient Registrations Over Time (Line Chart)
{% if has_registration_data %}
const registrationCtx = document.getElementById('registrationChart').getContext('2d');
new Chart(registrationCtx, {
    type: 'line',
    data: {
        labels: {{ registration_months|safe }},
        datasets: [{
            label: 'New Registrations',
            data: {{ registration_counts|safe }},
            borderColor: 'rgba(255, 206, 86, 1)',
            backgroundColor: 'rgba(255, 206, 86, 0.2)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
{% endif %}

// Patients by Department (Bar Chart)
{% if has_department_data %}
const departmentCtx = document.getElementById('departmentChart').getContext('2d');
new Chart(departmentCtx, {
    type: 'bar',
    data: {
        labels: {{ dept_labels|safe }},
        datasets: [{
            label: 'Number of Patients',
            data: {{ dept_patient_data|safe }},
            backgroundColor: 'rgba(220, 53, 69, 0.8)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const label = {{ dept_labels|safe }}[index];
                navigateToFilteredPatients('department', label);
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        return 'Click to view patients';
                    }
                }
            }
        }
    }
});
{% endif %}

// BMI Distribution (Pie Chart)
{% if has_bmi_data %}
const bmiCtx = document.getElementById('bmiChart').getContext('2d');
new Chart(bmiCtx, {
    type: 'pie',
    data: {
        labels: {{ bmi_labels|safe }},
        datasets: [{
            data: {{ bmi_counts|safe }},
            backgroundColor: [
                'rgba(75, 192, 192, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(255, 99, 132, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const label = {{ bmi_labels|safe }}[index];
                navigateToFilteredPatients('bmi', label);
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        return 'Click to view patients';
                    }
                }
            }
        }
    }
});
{% endif %}

// Visit Type Distribution (Doughnut Chart)
{% if has_visit_type_data %}
const visitTypeCtx = document.getElementById('visitTypeChart').getContext('2d');
new Chart(visitTypeCtx, {
    type: 'doughnut',
    data: {
        labels: {{ visit_type_labels|safe }},
        datasets: [{
            data: {{ visit_type_counts|safe }},
            backgroundColor: [
                'rgba(13, 110, 253, 0.85)',
                'rgba(25, 135, 84, 0.85)',
                'rgba(255, 193, 7, 0.85)',
                'rgba(220, 53, 69, 0.85)',
                'rgba(111, 66, 193, 0.85)',
                'rgba(32, 201, 151, 0.85)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const label = {{ visit_type_labels|safe }}[index];
                navigateToFilteredPatients('visit_type', label);
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        return 'Click to view patients';
                    }
                }
            }
        }
    }
});
{% endif %}

// City Distribution (Bar Chart)
{% if has_city_data %}
const cityCtx = document.getElementById('cityChart').getContext('2d');
new Chart(cityCtx, {
    type: 'bar',
    data: {
        labels: {{ city_labels|safe }},
        datasets: [{
            label: 'Patients',
            data: {{ city_counts|safe }},
            backgroundColor: 'rgba(102, 16, 242, 0.8)',
            borderColor: 'rgba(102, 16, 242, 1)',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const label = {{ city_labels|safe }}[index];
                navigateToFilteredPatients('city', label);
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        return 'Click to view patients';
                    }
                }
            }
        }
    }
});
{% endif %}

// Top Diagnoses (Bar Chart - Horizontal)
{% if has_diagnosis_data %}
const diagnosisCtx = document.getElementById('diagnosisChart').getContext('2d');
new Chart(diagnosisCtx, {
    type: 'bar',
    data: {
        labels: {{ diagnosis_labels|safe }},
        datasets: [{
            label: 'Number of Cases',
            data: {{ diagnosis_counts|safe }},
            backgroundColor: 'rgba(108, 117, 125, 0.8)',
            borderColor: 'rgba(108, 117, 125, 1)',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const label = {{ diagnosis_labels|safe }}[index];
                navigateToFilteredPatients('diagnosis', label);
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        return 'Click to view patients';
                    }
                }
            }
        }
    }
});
{% endif %}

// Average Vitals by Department (Grouped Bar Chart)
{% if has_dept_vitals_data %}
const deptVitalsCtx = document.getElementById('deptVitalsChart').getContext('2d');
new Chart(deptVitalsCtx, {
    type: 'bar',
    data: {
        labels: {{ dept_vital_labels|safe }},
        datasets: [
            {
                label: 'Avg Systolic BP (mmHg)',
                data: {{ dept_vital_systolic|safe }},
                backgroundColor: 'rgba(13, 110, 253, 0.8)'
            },
            {
                label: 'Avg Diastolic BP (mmHg)',
                data: {{ dept_vital_diastolic|safe }},
                backgroundColor: 'rgba(25, 135, 84, 0.8)'
            },
            {
                label: 'Avg Heart Rate (bpm)',
                data: {{ dept_vital_heart_rate|safe }},
                backgroundColor: 'rgba(255, 193, 7, 0.8)'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}

